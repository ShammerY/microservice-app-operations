pipeline {
    agent any
    
    environment {
        // Network name
        NETWORK_NAME = 'microservice-network'
        REGISTRY_PREFIX = 'microservices'
    }
    
    parameters {
        choice(
            name: 'DESTRUCTION_LEVEL',
            choices: ['CONTAINERS_ONLY', 'CONTAINERS_AND_IMAGES', 'FULL_CLEANUP'],
            description: 'Nivel de destrucciÃ³n a realizar'
        )
        booleanParam(
            name: 'FORCE_REMOVAL',
            defaultValue: false,
            description: 'Forzar remociÃ³n de contenedores (kill -9)'
        )
    }
    
    stages {
        stage('Destruction Planning') {
            steps {
                script {
                    echo "ğŸ¯ Planificando destrucciÃ³n..."
                    echo "ğŸ“‹ Nivel seleccionado: ${params.DESTRUCTION_LEVEL}"
                    echo "âš¡ Forzar remociÃ³n: ${params.FORCE_REMOVAL}"
                    
                    // Mostrar estado actual
                    sh """
                        echo "ğŸ“Š Estado actual del sistema:"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo "Contenedores corriendo:"
                        docker ps --format "table {{.Names}}\\t{{.Status}}" | grep -E "(redis|auth-api|users-api|todos-api|log-message-processor|frontend)" || echo "Ninguno"
                        echo ""
                        echo "Contenedores detenidos:" 
                        docker ps -a --format "table {{.Names}}\\t{{.Status}}" | grep -E "(redis|auth-api|users-api|todos-api|log-message-processor|frontend)" || echo "Ninguno"
                        echo ""
                        echo "ImÃ¡genes disponibles:"
                        docker images | grep ${REGISTRY_PREFIX} || echo "Ninguna"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    """
                }
            }
        }
        
        stage('Stop Services') {
            steps {
                script {
                    echo "ğŸ›‘ Deteniendo todos los servicios..."
                    
                    def containers = ['frontend', 'todos-api', 'log-message-processor', 'users-api', 'auth-api', 'redis']
                    
                    containers.each { container ->
                        try {
                            def isRunning = sh(
                                script: "docker ps -q -f name=${container}",
                                returnStdout: true
                            ).trim()
                            
                            if (isRunning) {
                                if (params.FORCE_REMOVAL) {
                                    echo "ğŸ’¥ Forzando detenciÃ³n de ${container}..."
                                    sh "docker kill ${container}"
                                } else {
                                    echo "ğŸ›‘ Deteniendo ${container} gracefully..."
                                    sh "timeout 30s docker stop ${container} || docker kill ${container}"
                                }
                                echo "âœ… ${container} detenido correctamente"
                            } else {
                                echo "â¹ï¸ ${container} ya estaba detenido"
                            }
                        } catch (Exception e) {
                            echo "âš ï¸ Error deteniendo ${container}: ${e.getMessage()}"
                        }
                    }
                    
                    echo "âœ… Todos los servicios han sido detenidos"
                }
            }
        }
        
        stage('Remove Containers') {
            steps {
                script {
                    echo "ğŸ—‘ï¸ Removiendo contenedores..."
                    
                    def containers = ['frontend', 'todos-api', 'log-message-processor', 'users-api', 'auth-api', 'redis']
                    
                    containers.each { container ->
                        try {
                            def exists = sh(
                                script: "docker ps -aq -f name=${container}",
                                returnStdout: true
                            ).trim()
                            
                            if (exists) {
                                echo "ğŸ—‘ï¸ Removiendo contenedor ${container}..."
                                
                                if (params.FORCE_REMOVAL) {
                                    sh "docker rm -f ${container}"
                                } else {
                                    sh "docker rm ${container}"
                                }
                                echo "âœ… Contenedor ${container} removido correctamente"
                            } else {
                                echo "ğŸ“­ Contenedor ${container} no existe"
                            }
                        } catch (Exception e) {
                            echo "âš ï¸ Error removiendo ${container}: ${e.getMessage()}"
                        }
                    }
                    
                    echo "âœ… Todos los contenedores han sido removidos"
                }
            }
        }
        
        stage('Remove Images') {
            when {
                anyOf {
                    expression { params.DESTRUCTION_LEVEL == 'CONTAINERS_AND_IMAGES' }
                    expression { params.DESTRUCTION_LEVEL == 'FULL_CLEANUP' }
                }
            }
            steps {
                script {
                    echo "ğŸ–¼ï¸ Removiendo imÃ¡genes Docker..."
                    
                    def services = ['auth-api', 'users-api', 'todos-api', 'log-message-processor', 'frontend']
                    
                    services.each { service ->
                        try {
                            // Remover imagen latest
                            def imageExists = sh(
                                script: "docker images -q ${REGISTRY_PREFIX}/${service}:latest",
                                returnStdout: true
                            ).trim()
                            
                            if (imageExists) {
                                echo "ğŸ—‘ï¸ Removiendo imagen ${REGISTRY_PREFIX}/${service}:latest..."
                                sh "docker rmi ${REGISTRY_PREFIX}/${service}:latest"
                                echo "âœ… Imagen ${service} removida correctamente"
                            } else {
                                echo "ğŸ“­ Imagen ${service} no existe"
                            }
                            
                            // Remover otras versiones con tag numÃ©rico
                            sh """
                                echo "ğŸ” Buscando otras versiones de ${service}..."
                                docker images | grep "${REGISTRY_PREFIX}/${service}" | awk '{print \$1\":\"\$2}' | xargs -r docker rmi || echo "No hay otras versiones"
                            """
                            
                        } catch (Exception e) {
                            echo "âš ï¸ Error removiendo imagen ${service}: ${e.getMessage()}"
                        }
                    }
                    
                    echo "âœ… Todas las imÃ¡genes han sido procesadas"
                }
            }
        }
        
        stage('Remove Network') {
            steps {
                script {
                    echo "ğŸŒ Removiendo red de Docker..."
                    try {
                        def networkExists = sh(
                            script: "docker network ls -q -f name=${NETWORK_NAME}",
                            returnStdout: true
                        ).trim()
                        
                        if (networkExists) {
                            echo "ğŸ—‘ï¸ Removiendo red ${NETWORK_NAME}..."
                            sh "docker network rm ${NETWORK_NAME}"
                            echo "âœ… Red ${NETWORK_NAME} removida correctamente"
                        } else {
                            echo "ğŸ“­ Red ${NETWORK_NAME} no existe"
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ Error removiendo red: ${e.getMessage()}"
                        echo "Esto puede suceder si hay contenedores aÃºn conectados a la red"
                    }
                }
            }
        }
        
        stage('Advanced Cleanup') {
            when {
                expression { params.DESTRUCTION_LEVEL == 'FULL_CLEANUP' }
            }
            steps {
                script {
                    echo "ğŸ§¹ Realizando limpieza avanzada del sistema..."
                    
                    try {
                        echo "ğŸ—‘ï¸ Limpiando volÃºmenes no utilizados..."
                        sh "docker volume prune -f"
                        
                        echo "ğŸ—‘ï¸ Limpiando imÃ¡genes huÃ©rfanas..."
                        sh "docker image prune -f"
                        
                        echo "ğŸ—‘ï¸ Limpiando contenedores detenidos..."
                        sh "docker container prune -f"
                        
                        echo "ğŸ—‘ï¸ Limpieza general del sistema..."
                        sh "docker system prune -f"
                        
                        echo "âœ… Limpieza avanzada completada"
                    } catch (Exception e) {
                        echo "âš ï¸ Error en limpieza avanzada: ${e.getMessage()}"
                    }
                }
            }
        }
        
        stage('Final Verification') {
            steps {
                script {
                    echo "ğŸ” Verificando que la destrucciÃ³n fue exitosa..."
                    
                    // Verificar contenedores
                    def runningContainers = sh(
                        script: "docker ps --format '{{.Names}}' | grep -E '(frontend|todos-api|log-message-processor|users-api|auth-api|redis)' || true",
                        returnStdout: true
                    ).trim()
                    
                    def allContainers = sh(
                        script: "docker ps -a --format '{{.Names}}' | grep -E '(frontend|todos-api|log-message-processor|users-api|auth-api|redis)' || true",
                        returnStdout: true
                    ).trim()
                    
                    if (runningContainers) {
                        echo "âš ï¸ AÃºn hay contenedores corriendo: ${runningContainers}"
                    } else {
                        echo "âœ… No hay contenedores de microservicios corriendo"
                    }
                    
                    if (allContainers) {
                        echo "âš ï¸ AÃºn existen contenedores: ${allContainers}"
                    } else {
                        echo "âœ… No existen contenedores de microservicios"
                    }
                    
                    // Verificar imÃ¡genes si se pidiÃ³ removerlas
                    if (params.DESTRUCTION_LEVEL != 'CONTAINERS_ONLY') {
                        def remainingImages = sh(
                            script: "docker images | grep ${REGISTRY_PREFIX} || true",
                            returnStdout: true
                        ).trim()
                        
                        if (remainingImages) {
                            echo "âš ï¸ AÃºn quedan imÃ¡genes:"
                            sh "docker images | grep ${REGISTRY_PREFIX}"
                        } else {
                            echo "âœ… No quedan imÃ¡genes de microservicios"
                        }
                    }
                    
                    // Verificar red
                    def networkExists = sh(
                        script: "docker network ls | grep ${NETWORK_NAME} || true",
                        returnStdout: true
                    ).trim()
                    
                    if (networkExists) {
                        echo "âš ï¸ La red ${NETWORK_NAME} aÃºn existe"
                    } else {
                        echo "âœ… La red ${NETWORK_NAME} fue removida correctamente"
                    }
                    
                    // Mostrar estado final del sistema
                    sh """
                        echo ""
                        echo "ğŸ“Š Estado final del sistema Docker:"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo "Contenedores activos: \$(docker ps | wc -l) (incluyendo header)"
                        echo "Contenedores totales: \$(docker ps -a | wc -l) (incluyendo header)"
                        echo "ImÃ¡genes totales: \$(docker images | wc -l) (incluyendo header)"
                        echo "Redes: \$(docker network ls | wc -l) (incluyendo header)"
                        echo "VolÃºmenes: \$(docker volume ls | wc -l) (incluyendo header)"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        
                        echo "ğŸ’¾ Uso de espacio en disco:"
                        docker system df
                    """
                }
            }
        }
    }
    
    post {
        success {
            script {
                def destructionSummary = ""
                switch(params.DESTRUCTION_LEVEL) {
                    case 'CONTAINERS_ONLY':
                        destructionSummary = "ğŸ—‘ï¸ Contenedores removidos, imÃ¡genes conservadas"
                        break
                    case 'CONTAINERS_AND_IMAGES':
                        destructionSummary = "ğŸ—‘ï¸ Contenedores e imÃ¡genes removidos"
                        break
                    case 'FULL_CLEANUP':
                        destructionSummary = "ğŸ—‘ï¸ Limpieza completa del sistema"
                        break
                }
                
                echo """
                ğŸ‰ Â¡DESTRUCCIÃ“N COMPLETADA EXITOSAMENTE!
                
                ${destructionSummary}
                
                ğŸ“Š Elementos procesados:
                â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                âŒ Redis                 â†’ Detenido y removido
                âŒ Auth API              â†’ Detenido y removido
                âŒ Users API             â†’ Detenido y removido  
                âŒ Todos API             â†’ Detenido y removido
                âŒ Log Message Processor â†’ Detenido y removido
                âŒ Frontend              â†’ Detenido y removido
                âŒ Red: ${NETWORK_NAME}   â†’ Removida
                â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                
                âœ¨ El sistema estÃ¡ limpio y listo para un nuevo despliegue.
                
                ğŸ”„ Para volver a desplegar:
                1. Jenkinsfile-Build    â†’ Construir imÃ¡genes
                2. Jenkinsfile-Create   â†’ Crear contenedores  
                3. Jenkinsfile-Start    â†’ Iniciar servicios
                
                ğŸ’¡ Tip: Usa CONTAINERS_ONLY si quieres mantener las imÃ¡genes para deployments mÃ¡s rÃ¡pidos
                """
            }
        }
        
        failure {
            echo """
            âš ï¸ LA DESTRUCCIÃ“N TUVO ALGUNOS PROBLEMAS
            
            Algunos recursos pueden no haber sido removidos completamente.
            
            ğŸ”§ Comandos para limpieza manual:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            docker stop \$(docker ps -aq)                    # Detener todo
            docker rm \$(docker ps -aq)                      # Remover contenedores
            docker rmi \$(docker images -q)                  # Remover imÃ¡genes  
            docker network prune -f                          # Limpiar redes
            docker system prune -af                          # Limpieza total
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            âš ï¸ CUIDADO: Los comandos anteriores afectarÃ¡n TODOS los contenedores e imÃ¡genes Docker
            """
        }
        
        always {
            echo "ğŸ Pipeline de destrucciÃ³n finalizado"
        }
    }
}