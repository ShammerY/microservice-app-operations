pipeline {
    agent any
    
    environment {
        // Repositorio de desarrollo donde estÃ¡ el cÃ³digo fuente
        DEV_REPO = 'https://github.com/SantiagoAngel007/microservice-app-example.git'
        DEV_BRANCH = 'feature/test-startup'
        
        // Variables de configuraciÃ³n para build
        IMAGE_TAG = "${BUILD_NUMBER}"
        REGISTRY_PREFIX = 'microservices'
    }
    
    stages {
        stage('Checkout Development Code') {
            steps {
                script {
                    echo "ğŸ“¥ Clonando repositorio de desarrollo..."
                    sh "rm -rf microservice-app-example"
                    sh "git clone ${DEV_REPO} microservice-app-example"
                    sh "cd microservice-app-example && git checkout ${DEV_BRANCH}"
                    
                    // Mostrar informaciÃ³n del commit y estructura
                    sh """
                        cd microservice-app-example
                        echo "ğŸ“‹ InformaciÃ³n del commit:"
                        git log --oneline -1
                        echo "ğŸŒ¿ Rama: ${DEV_BRANCH}"
                        echo "ğŸ·ï¸ Tag de imagen: ${IMAGE_TAG}"
                        echo ""
                        echo "ğŸ“ Estructura del proyecto:"
                        ls -la
                        echo ""
                        echo "ğŸ“ Contenido de auth-api:"
                        ls -la auth-api/
                    """
                }
            }
        }
        
        stage('Cleanup Old Images') {
            steps {
                script {
                    echo "ğŸ§¹ Limpiando imÃ¡genes anteriores..."
                    sh '''
                        # Remover imÃ¡genes previas para build fresco
                        docker rmi ${REGISTRY_PREFIX}/auth-api:latest 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/users-api:latest 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/todos-api:latest 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/log-message-processor:latest 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/frontend:latest 2>/dev/null || true
                        
                        # TambiÃ©n limpiar por tag especÃ­fico
                        docker rmi ${REGISTRY_PREFIX}/auth-api:${IMAGE_TAG} 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/users-api:${IMAGE_TAG} 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/todos-api:${IMAGE_TAG} 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/log-message-processor:${IMAGE_TAG} 2>/dev/null || true
                        docker rmi ${REGISTRY_PREFIX}/frontend:${IMAGE_TAG} 2>/dev/null || true
                        
                        echo "âœ… Limpieza de imÃ¡genes completada"
                    '''
                }
            }
        }
        
        stage('Prepare Go Modules for Auth API') {
            steps {
                script {
                    echo "ğŸ”§ Preparando mÃ³dulos Go para Auth API..."
                    dir('microservice-app-example/auth-api') {
                        sh '''
                            echo "ğŸ“‹ Verificando archivos existentes:"
                            ls -la
                            
                            # Si no existe go.mod, crearlo desde Gopkg
                            if [ ! -f go.mod ]; then
                                echo "ğŸ“¦ Inicializando mÃ³dulo Go..."
                                export GO111MODULE=on
                                go mod init github.com/bortizf/microservice-app-example/auth-api
                                
                                # Si existe Gopkg.toml, convertir dependencias
                                if [ -f Gopkg.toml ]; then
                                    echo "ğŸ”„ Convirtiendo desde Gopkg..."
                                    # Agregar dependencias manualmente basadas en el Gopkg.toml
                                    go get github.com/dgrijalva/jwt-go@v3.1.0
                                    go get github.com/labstack/echo@v3.2.6
                                    go get github.com/openzipkin/zipkin-go@master
                                fi
                                
                                echo "ğŸ”„ Descargando dependencias..."
                                go mod tidy
                            fi
                            
                            echo "âœ… MÃ³dulos Go preparados:"
                            cat go.mod
                        '''
                    }
                }
            }
        }
        
        stage('Build Auth API') {
            steps {
                script {
                    echo "ğŸ” Construyendo Auth API..."
                    dir('microservice-app-example/auth-api') {
                        sh """
                            echo "ğŸ—ï¸ Building Auth API Docker image..."
                            docker build -t ${REGISTRY_PREFIX}/auth-api:latest .
                            docker tag ${REGISTRY_PREFIX}/auth-api:latest ${REGISTRY_PREFIX}/auth-api:${IMAGE_TAG}
                            
                            echo "âœ… Auth API imagen creada:"
                            docker images | grep ${REGISTRY_PREFIX}/auth-api
                        """
                    }
                }
            }
        }
        
        stage('Build Users API') {
            steps {
                script {
                    echo "ğŸ‘¥ Construyendo Users API..."
                    dir('microservice-app-example/users-api') {
                        sh """
                            echo "ğŸ“‹ Verificando estructura Maven:"
                            ls -la
                            
                            echo "ğŸ—ï¸ Compilando con Maven..."
                            ./mvnw clean package -DskipTests
                            
                            echo "ğŸ—ï¸ Building Users API Docker image..."
                            docker build -t ${REGISTRY_PREFIX}/users-api:latest .
                            docker tag ${REGISTRY_PREFIX}/users-api:latest ${REGISTRY_PREFIX}/users-api:${IMAGE_TAG}
                            
                            echo "âœ… Users API imagen creada:"
                            docker images | grep ${REGISTRY_PREFIX}/users-api
                        """
                    }
                }
            }
        }
        
        stage('Build Todos API') {
            steps {
                script {
                    echo "ğŸ“ Construyendo Todos API..."
                    dir('microservice-app-example/todos-api') {
                        sh """
                            echo "ğŸ“‹ Verificando package.json:"
                            ls -la
                            cat package.json
                            
                            echo "ğŸ—ï¸ Building Todos API Docker image..."
                            docker build -t ${REGISTRY_PREFIX}/todos-api:latest .
                            docker tag ${REGISTRY_PREFIX}/todos-api:latest ${REGISTRY_PREFIX}/todos-api:${IMAGE_TAG}
                            
                            echo "âœ… Todos API imagen creada:"
                            docker images | grep ${REGISTRY_PREFIX}/todos-api
                        """
                    }
                }
            }
        }
        
        stage('Build Log Message Processor') {
            steps {
                script {
                    echo "ğŸ“Š Construyendo Log Message Processor..."
                    dir('microservice-app-example/log-message-processor') {
                        sh """
                            echo "ğŸ“‹ Verificando requirements.txt:"
                            ls -la
                            cat requirements.txt
                            
                            echo "ğŸ—ï¸ Building Log Processor Docker image..."
                            docker build -t ${REGISTRY_PREFIX}/log-message-processor:latest .
                            docker tag ${REGISTRY_PREFIX}/log-message-processor:latest ${REGISTRY_PREFIX}/log-message-processor:${IMAGE_TAG}
                            
                            echo "âœ… Log Processor imagen creada:"
                            docker images | grep ${REGISTRY_PREFIX}/log-message-processor
                        """
                    }
                }
            }
        }
        
        stage('Build Frontend') {
            steps {
                script {
                    echo "ğŸ–¥ï¸ Construyendo Frontend..."
                    dir('microservice-app-example/frontend') {
                        sh """
                            echo "ğŸ“‹ Verificando package.json:"
                            ls -la
                            head -20 package.json
                            
                            echo "ğŸ—ï¸ Building Frontend Docker image..."
                            docker build -t ${REGISTRY_PREFIX}/frontend:latest .
                            docker tag ${REGISTRY_PREFIX}/frontend:latest ${REGISTRY_PREFIX}/frontend:${IMAGE_TAG}
                            
                            echo "âœ… Frontend imagen creada:"
                            docker images | grep ${REGISTRY_PREFIX}/frontend
                        """
                    }
                }
            }
        }
        
        stage('Verify All Images') {
            steps {
                script {
                    echo "ğŸ” Verificando que todas las imÃ¡genes se crearon correctamente..."
                    sh """
                        echo "ğŸ“Š Resumen de imÃ¡genes creadas:"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        docker images | grep ${REGISTRY_PREFIX} | head -10
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        
                        # Verificar que cada imagen existe
                        echo "ğŸ” VerificaciÃ³n individual:"
                        docker inspect ${REGISTRY_PREFIX}/auth-api:latest >/dev/null 2>&1 && echo "âœ… Auth API: OK" || echo "âŒ Auth API: MISSING"
                        docker inspect ${REGISTRY_PREFIX}/users-api:latest >/dev/null 2>&1 && echo "âœ… Users API: OK" || echo "âŒ Users API: MISSING"
                        docker inspect ${REGISTRY_PREFIX}/todos-api:latest >/dev/null 2>&1 && echo "âœ… Todos API: OK" || echo "âŒ Todos API: MISSING"
                        docker inspect ${REGISTRY_PREFIX}/log-message-processor:latest >/dev/null 2>&1 && echo "âœ… Log Processor: OK" || echo "âŒ Log Processor: MISSING"
                        docker inspect ${REGISTRY_PREFIX}/frontend:latest >/dev/null 2>&1 && echo "âœ… Frontend: OK" || echo "âŒ Frontend: MISSING"
                        
                        # Contar imÃ¡genes creadas
                        CREATED_IMAGES=\$(docker images | grep ${REGISTRY_PREFIX} | grep latest | wc -l)
                        echo ""
                        echo "ğŸ“Š Total de imÃ¡genes creadas: \$CREATED_IMAGES/5"
                        
                        if [ "\$CREATED_IMAGES" != "5" ]; then
                            echo "âŒ Error: No se crearon todas las imÃ¡genes"
                            exit 1
                        else
                            echo "âœ… Todas las imÃ¡genes se crearon exitosamente"
                        fi
                    """
                }
            }
        }
        
        stage('Image Size Analysis') {
            steps {
                script {
                    echo "ğŸ“Š AnÃ¡lisis del tamaÃ±o de imÃ¡genes..."
                    sh """
                        echo "ğŸ“ TamaÃ±o de las imÃ¡genes creadas:"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        docker images | grep ${REGISTRY_PREFIX} | grep latest | awk '{printf "%-30s %s\\n", \$1\":\"\$2, \$7}'
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        
                        echo "ğŸ’¾ Uso total de espacio:"
                        docker system df | grep Images
                    """
                }
            }
        }
        
        stage('Image Cleanup') {
            steps {
                script {
                    echo "ğŸ§¹ Limpieza de imÃ¡genes intermedias..."
                    sh """
                        # Limpiar imÃ¡genes huÃ©rfanas del build
                        docker image prune -f
                        
                        echo "ğŸ“Š Espacio liberado y estado final:"
                        docker system df
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ§¹ Limpiando workspace..."
                sh "rm -rf microservice-app-example"
            }
        }
        
        success {
            echo """
            ğŸ‰ Â¡BUILD COMPLETADO EXITOSAMENTE!
            
            ğŸŒ¿ Rama compilada: ${DEV_BRANCH}
            ğŸ·ï¸ Tag de imÃ¡genes: ${IMAGE_TAG}
            
            ğŸ“¦ ImÃ¡genes creadas:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ” ${REGISTRY_PREFIX}/auth-api:latest
            ğŸ‘¥ ${REGISTRY_PREFIX}/users-api:latest  
            ğŸ“ ${REGISTRY_PREFIX}/todos-api:latest
            ğŸ“Š ${REGISTRY_PREFIX}/log-message-processor:latest
            ğŸ–¥ï¸ ${REGISTRY_PREFIX}/frontend:latest
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            â¡ï¸ PrÃ³ximo paso: Ejecutar microservice-create para crear contenedores
            
            ğŸ’¡ Comando de verificaciÃ³n:
            docker images | grep ${REGISTRY_PREFIX}
            """
            
            script {
                sh """
                    echo "ğŸ“Š Resumen final:"
                    docker images | grep ${REGISTRY_PREFIX} | wc -l | awk '{print "ImÃ¡genes creadas: " \$1 "/5"}'
                """
            }
        }
        
        failure {
            echo """
            âŒ BUILD FALLIDO
            
            ğŸ” Revisa los logs para identificar quÃ© imagen fallÃ³ al construirse.
            
            ğŸ› ï¸ Posibles problemas y soluciones:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ Auth API: Problemas con Go modules â†’ Verificar Dockerfile y dependencias
            â€¢ Users API: Problemas con Maven â†’ Verificar ./mvnw permisos y pom.xml
            â€¢ Todos API: Problemas con npm â†’ Verificar package.json
            â€¢ Log Processor: Problemas con pip â†’ Verificar requirements.txt
            â€¢ Frontend: Problemas con build â†’ Verificar dependencias Vue
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            """
            script {
                sh """
                    echo "ğŸ§¹ Limpiando imÃ¡genes parciales que puedan haber quedado..."
                    
                    # Mostrar quÃ© imÃ¡genes se crearon parcialmente
                    echo "ğŸ“Š Estado actual de imÃ¡genes:"
                    docker images | grep ${REGISTRY_PREFIX} || echo "No hay imÃ¡genes de microservicios"
                    
                    # Limpiar imÃ¡genes con problemas
                    docker image prune -f
                    
                    # Forzar limpieza de imÃ¡genes problemÃ¡ticas
                    docker images | grep '<none>' | awk '{print \$3}' | xargs -r docker rmi -f || true
                """
            }
        }
    }
}