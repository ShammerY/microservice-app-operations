pipeline {
    agent any
    
    environment {
        // Variables de configuraciÃ³n
        AUTH_API_PORT = '8000'
        USERS_API_PORT = '8083'
        TODOS_API_PORT = '8082'
        FRONTEND_PORT = '8080'
    }
    
    stages {
        stage('Verify Containers Exist') {
            steps {
                script {
                    echo "ğŸ” Verificando que los contenedores existan..."
                    
                    def containers = ['redis', 'auth-api', 'users-api', 'todos-api', 'log-message-processor', 'frontend']
                    def missingContainers = []
                    
                    containers.each { container ->
                        def exists = sh(
                            script: "docker ps -aq -f name=${container}",
                            returnStdout: true
                        ).trim()
                        
                        if (exists) {
                            // Verificar el estado actual
                            def status = sh(
                                script: "docker inspect ${container} --format '{{.State.Status}}'",
                                returnStdout: true
                            ).trim()
                            
                            echo "âœ… ${container}: Existe (Estado: ${status})"
                        } else {
                            echo "âŒ ${container}: No existe"
                            missingContainers.add(container)
                        }
                    }
                    
                    if (missingContainers.size() > 0) {
                        error("âŒ Faltan los siguientes contenedores: ${missingContainers.join(', ')}. Ejecuta Jenkinsfile-Create primero.")
                    }
                    
                    echo "âœ… Todos los contenedores estÃ¡n disponibles!"
                }
            }
        }
        
        stage('Stop Running Containers') {
            steps {
                script {
                    echo "ğŸ›‘ Deteniendo contenedores que puedan estar corriendo..."
                    
                    def containers = ['redis', 'auth-api', 'users-api', 'todos-api', 'log-message-processor', 'frontend']
                    
                    containers.each { container ->
                        def isRunning = sh(
                            script: "docker ps -q -f name=${container}",
                            returnStdout: true
                        ).trim()
                        
                        if (isRunning) {
                            echo "ğŸ›‘ Deteniendo: ${container}"
                            sh "docker stop ${container}"
                        } else {
                            echo "â¹ï¸ ${container}: Ya estÃ¡ detenido"
                        }
                    }
                    
                    echo "âœ… Todos los contenedores estÃ¡n detenidos"
                }
            }
        }
        
        stage('Start Redis') {
            steps {
                script {
                    echo "ğŸ”´ Iniciando Redis..."
                    sh "docker start redis"
                    
                    echo "â³ Esperando que Redis se inicialice..."
                    sleep(5)
                    
                    // Verificar que Redis estÃ¡ corriendo
                    def isRunning = sh(
                        script: "docker ps -q -f name=redis",
                        returnStdout: true
                    ).trim()
                    
                    if (isRunning) {
                        echo "âœ… Redis iniciado correctamente"
                        sh "docker logs redis --tail 3"
                    } else {
                        error("âŒ Redis fallÃ³ al iniciar")
                    }
                }
            }
        }
        
        stage('Start Auth API') {
            steps {
                script {
                    echo "ğŸ” Iniciando Auth API..."
                    sh "docker start auth-api"
                    
                    echo "â³ Esperando que Auth API se inicialice..."
                    sleep(10)
                    
                    // Verificar que Auth API estÃ¡ corriendo
                    def isRunning = sh(
                        script: "docker ps -q -f name=auth-api",
                        returnStdout: true
                    ).trim()
                    
                    if (isRunning) {
                        echo "âœ… Auth API iniciado correctamente"
                        
                        // Intentar health check
                        def healthCheck = sh(
                            script: "curl -f http://localhost:${AUTH_API_PORT}/version || echo 'Health check failed'",
                            returnStdout: true
                        ).trim()
                        
                        echo "ğŸ” Health check: ${healthCheck}"
                    } else {
                        echo "âŒ Auth API fallÃ³ al iniciar"
                        sh "docker logs auth-api --tail 10"
                        error("Auth API startup failed")
                    }
                }
            }
        }
        
        stage('Start Users API') {
            steps {
                script {
                    echo "ğŸ‘¥ Iniciando Users API..."
                    sh "docker start users-api"
                    
                    echo "â³ Esperando que Users API se inicialice..."
                    sleep(15)
                    
                    // Verificar que Users API estÃ¡ corriendo
                    def isRunning = sh(
                        script: "docker ps -q -f name=users-api",
                        returnStdout: true
                    ).trim()
                    
                    if (isRunning) {
                        echo "âœ… Users API iniciado correctamente"
                        sh "docker logs users-api --tail 5"
                    } else {
                        echo "âŒ Users API fallÃ³ al iniciar"
                        sh "docker logs users-api --tail 10"
                        error("Users API startup failed")
                    }
                }
            }
        }
        
        stage('Start Todos API') {
            steps {
                script {
                    echo "ğŸ“ Iniciando Todos API..."
                    sh "docker start todos-api"
                    
                    echo "â³ Esperando que Todos API se inicialice..."
                    sleep(10)
                    
                    // Verificar que Todos API estÃ¡ corriendo
                    def isRunning = sh(
                        script: "docker ps -q -f name=todos-api",
                        returnStdout: true
                    ).trim()
                    
                    if (isRunning) {
                        echo "âœ… Todos API iniciado correctamente"
                        sh "docker logs todos-api --tail 5"
                    } else {
                        echo "âŒ Todos API fallÃ³ al iniciar"
                        sh "docker logs todos-api --tail 10"
                        error("Todos API startup failed")
                    }
                }
            }
        }
        
        stage('Start Log Message Processor') {
            steps {
                script {
                    echo "ğŸ“Š Iniciando Log Message Processor..."
                    sh "docker start log-message-processor"
                    
                    echo "â³ Esperando que Log Processor se inicialice..."
                    sleep(5)
                    
                    // Verificar que Log Processor estÃ¡ corriendo
                    def isRunning = sh(
                        script: "docker ps -q -f name=log-message-processor",
                        returnStdout: true
                    ).trim()
                    
                    if (isRunning) {
                        echo "âœ… Log Message Processor iniciado correctamente"
                        sh "docker logs log-message-processor --tail 3"
                    } else {
                        echo "âŒ Log Message Processor fallÃ³ al iniciar"
                        sh "docker logs log-message-processor --tail 10"
                        error("Log Message Processor startup failed")
                    }
                }
            }
        }
        
        stage('Start Frontend') {
            steps {
                script {
                    echo "ğŸ–¥ï¸ Iniciando Frontend..."
                    sh "docker start frontend"
                    
                    echo "â³ Esperando que Frontend se inicialice..."
                    sleep(10)
                    
                    // Verificar que Frontend estÃ¡ corriendo
                    def isRunning = sh(
                        script: "docker ps -q -f name=frontend",
                        returnStdout: true
                    ).trim()
                    
                    if (isRunning) {
                        echo "âœ… Frontend iniciado correctamente"
                        
                        // Intentar health check
                        def healthCheck = sh(
                            script: "curl -f http://localhost:${FRONTEND_PORT}/ -o /dev/null -w '%{http_code}' || echo 'Health check failed'",
                            returnStdout: true
                        ).trim()
                        
                        echo "ğŸ” Frontend health check: ${healthCheck}"
                    } else {
                        echo "âŒ Frontend fallÃ³ al iniciar"
                        sh "docker logs frontend --tail 10"
                        error("Frontend startup failed")
                    }
                }
            }
        }
        
        stage('Final Health Check') {
            steps {
                script {
                    echo "ğŸ¥ Realizando verificaciÃ³n final de salud de todos los servicios..."
                    
                    // Mostrar estado de todos los contenedores
                    sh """
                        echo "ğŸ“Š Estado final de todos los servicios:"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        docker ps --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}" | grep -E "(redis|auth-api|users-api|todos-api|log-message-processor|frontend)"
                        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    """
                    
                    // Health checks especÃ­ficos
                    echo "ğŸ” Ejecutando health checks..."
                    
                    // Redis
                    def redisCheck = sh(
                        script: "docker exec redis redis-cli ping 2>/dev/null || echo 'FAIL'",
                        returnStdout: true
                    ).trim()
                    echo "ğŸ”´ Redis: ${redisCheck == 'PONG' ? 'âœ… OK' : 'âŒ FAIL'}"
                    
                    // Auth API
                    def authCheck = sh(
                        script: "curl -f -s http://localhost:${AUTH_API_PORT}/version || echo 'FAIL'",
                        returnStdout: true
                    ).trim()
                    echo "ğŸ” Auth API: ${authCheck.contains('Auth API') ? 'âœ… OK' : 'âŒ FAIL'}"
                    
                    // Frontend
                    def frontendCheck = sh(
                        script: "curl -f -s -o /dev/null -w '%{http_code}' http://localhost:${FRONTEND_PORT}/ || echo 'FAIL'",
                        returnStdout: true
                    ).trim()
                    echo "ğŸ–¥ï¸ Frontend: ${frontendCheck == '200' ? 'âœ… OK' : 'âŒ FAIL'}"
                    
                    // Verificar logs por errores crÃ­ticos
                    echo "ğŸ“‹ Revisando logs por errores crÃ­ticos..."
                    sh """
                        echo "ğŸ” Ãšltimos logs de cada servicio:"
                        echo "--- Auth API ---"
                        docker logs auth-api --tail 3 2>/dev/null || echo "No logs available"
                        echo "--- Users API ---" 
                        docker logs users-api --tail 3 2>/dev/null || echo "No logs available"
                        echo "--- Todos API ---"
                        docker logs todos-api --tail 3 2>/dev/null || echo "No logs available"
                    """
                }
            }
        }
        
        stage('Service Discovery Check') {
            steps {
                script {
                    echo "ğŸŒ Verificando conectividad entre servicios..."
                    
                    // Verificar que los servicios pueden comunicarse entre sÃ­ a travÃ©s de la red Docker
                    try {
                        sh """
                            echo "ğŸ” Probando conectividad interna:"
                            docker exec auth-api ping -c 1 users-api >/dev/null && echo "âœ… Auth API -> Users API: OK" || echo "âŒ Auth API -> Users API: FAIL"
                            docker exec todos-api ping -c 1 redis >/dev/null && echo "âœ… Todos API -> Redis: OK" || echo "âŒ Todos API -> Redis: FAIL"
                            docker exec log-message-processor ping -c 1 redis >/dev/null && echo "âœ… Log Processor -> Redis: OK" || echo "âŒ Log Processor -> Redis: FAIL"
                        """
                    } catch (Exception e) {
                        echo "âš ï¸ Algunos checks de conectividad fallaron, pero los servicios pueden estar funcionando"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo """
            ğŸ‰ Â¡TODOS LOS SERVICIOS INICIADOS EXITOSAMENTE!
            
            ğŸš€ Servicios activos:
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”´ Redis              â†’ localhost:6379             [Base de datos]
            ğŸ” Auth API           â†’ http://localhost:${AUTH_API_PORT}     [AutenticaciÃ³n]  
            ğŸ‘¥ Users API          â†’ http://localhost:${USERS_API_PORT}     [GestiÃ³n de usuarios]
            ğŸ“ Todos API          â†’ http://localhost:${TODOS_API_PORT}     [GestiÃ³n de tareas]
            ğŸ“Š Log Processor      â†’ [Procesamiento de logs]
            ğŸ–¥ï¸ Frontend           â†’ http://localhost:${FRONTEND_PORT}     [Interfaz de usuario]
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸŒŸ Â¡LA APLICACIÃ“N ESTÃ LISTA PARA USAR!
            
            ğŸ“± Accede a la aplicaciÃ³n: http://localhost:${FRONTEND_PORT}
            
            ğŸ”‘ Usuarios de prueba:
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ğŸ“‹ admin / admin    (Administrador)
            ğŸ“‹ johnd / foo      (Usuario)  
            ğŸ“‹ janed / ddd      (Usuario)
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            
            ğŸ› ï¸ Comandos Ãºtiles:
            â€¢ Ver logs: docker logs <service-name>
            â€¢ Estado: docker ps
            â€¢ Detener todos: Ejecutar Jenkinsfile-Destroy
            
            ğŸ’¡ Flujo de trabajo completo:
            1. âœ… Build    (Jenkinsfile-Build)    â†’ Crear imÃ¡genes  
            2. âœ… Create   (Jenkinsfile-Create)   â†’ Crear contenedores
            3. âœ… Start    (Jenkinsfile-Start)    â†’ Iniciar servicios
            4. ğŸ”„ Destroy  (Jenkinsfile-Destroy) â†’ Limpiar todo
            """
            
            script {
                sh """
                    echo ""
                    echo "ğŸ“Š Resumen final del sistema:"
                    echo "Contenedores corriendo: \$(docker ps | grep -E '(redis|auth-api|users-api|todos-api|log-message-processor|frontend)' | wc -l)/6"
                    echo "Uso de memoria:"
                    docker stats --no-stream --format "table {{.Name}}\\t{{.CPUPerc}}\\t{{.MemUsage}}" | head -7
                """
            }
        }
        
        failure {
            echo """
            âŒ FALLÃ“ EL INICIO DE LOS SERVICIOS
            
            ğŸ” Servicios que pueden estar fallando:
            """
            
            script {
                sh """
                    echo "ğŸ“Š Estado actual de contenedores:"
                    docker ps -a --format "table {{.Names}}\\t{{.Status}}" | grep -E "(redis|auth-api|users-api|todos-api|log-message-processor|frontend)"
                    
                    echo ""
                    echo "ğŸ” Logs de servicios que fallaron:"
                    for service in redis auth-api users-api todos-api log-message-processor frontend; do
                        if ! docker ps -q -f name=\$service | grep -q .; then
                            echo "--- \$service (FAILED) ---"
                            docker logs \$service --tail 5 2>/dev/null || echo "No logs available"
                            echo ""
                        fi
                    done
                """
            }
            
            echo """
            
            ğŸ› ï¸ Pasos para diagnosticar:
            1. Revisar logs: docker logs <service-name>
            2. Verificar imÃ¡genes: docker images | grep microservices
            3. Verificar contenedores: docker ps -a
            4. Reintentar: Ejecutar este pipeline nuevamente
            
            ğŸ”„ Si el problema persiste:
            â€¢ Ejecutar Jenkinsfile-Destroy
            â€¢ Ejecutar Jenkinsfile-Build  
            â€¢ Ejecutar Jenkinsfile-Create
            â€¢ Ejecutar Jenkinsfile-Start
            """
        }
    }
}